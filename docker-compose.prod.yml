version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: open-talent-postgres
    environment:
      POSTGRES_USER: OpenTalent
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: OpenTalent
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U OpenTalent -d OpenTalent"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Avatar Renderer Service (Node.js)
  avatar-renderer:
    build:
      context: ./ai-orchestra-simulation
      dockerfile: Dockerfile
    container_name: open-talent-avatar-renderer
    ports:
      - "${AVATAR_SERVICE_PORT}:${AVATAR_SERVICE_PORT}"
    environment:
      - NODE_ENV=production
      - PORT=${AVATAR_SERVICE_PORT}
    volumes:
      - ./ai-orchestra-simulation/src:/app/src:ro
      - ./ai-orchestra-simulation/assets:/app/assets:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Interview Service
  interview-service:
    build:
      context: ./microservices/interview-service
      dockerfile: Dockerfile
    container_name: open-talent-interview-service
    ports:
      - "${INTERVIEW_SERVICE_PORT}:80"
    environment:
      - DATABASE_URL=postgresql://OpenTalent:OpenTalent123@postgres:5432/OpenTalent
      - VOICE_SERVICE_URL=http://voice-service:80
      - CONVERSATION_SERVICE_URL=http://conversation-service:80
      - AVATAR_SERVICE_URL=http://avatar-renderer:${AVATAR_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
      voice-service:
        condition: service_healthy
      conversation-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Voice Service
  voice-service:
    build:
      context: ./microservices/voice-service
      dockerfile: Dockerfile
    container_name: open-talent-voice-service
    ports:
      - "${VOICE_SERVICE_PORT}:80"
    environment:
      - PYTHONPATH=/app
    volumes:
      - voice_models:/app/models
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Conversation Service
  conversation-service:
    build:
      context: ./microservices/conversation-service
      dockerfile: Dockerfile
    container_name: open-talent-conversation-service
    ports:
      - "${CONVERSATION_SERVICE_PORT}:80"
    environment:
      - PYTHONPATH=/app
      - OLLAMA_HOST=${OLLAMA_HOST}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Ollama Service for AI Models
  ollama:
    image: ollama/ollama:latest
    container_name: open-talent-ollama
    ports:
      - "${OLLAMA_PORT}:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    command: ["/bin/sh", "-c", "ollama serve & sleep 5 && ollama pull granite4:350m-h && wait"]
    healthcheck:
      test: ["CMD", "ollama", "list", "|", "grep", "granite4:350m-h"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Redis Service (Message Bus)
  redis:
    image: redis:alpine
    container_name: open-talent-redis
    ports:
      - "${REDIS_PORT}:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  voice_models:
  ollama_data:
