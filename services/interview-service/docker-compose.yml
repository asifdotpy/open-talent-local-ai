version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: talent_interview_postgres
    environment:
      POSTGRES_DB: talent_ai_interview
      POSTGRES_USER: talent_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5433:5432" # Use a different port to avoid conflict with root docker-compose
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U talent_user -d talent_ai_interview"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    container_name: talent_interview_redis
    ports:
      - "6380:6379"

  # vLLM - High-performance LLM inference engine
  vllm:
    image: vllm/vllm-openai:latest
    container_name: talent_vllm_server
    ports:
      - "8000:8000"
    volumes:
      - ${HOME}/.cache/huggingface:/root/.cache/huggingface
      - vllm_cache:/root/.cache
    environment:
      - CUDA_VISIBLE_DEVICES=0  # Use GPU if available
    command: >
      --model ibm/granite-3.1-2b-instruct
      --host 0.0.0.0
      --port 8000
      --dtype float16
      --max-model-len 2048
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/models"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Qdrant - Lightweight vector database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: talent_qdrant_db
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  interview-service:
    container_name: talent-interview-service-local
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8004:80"
    volumes:
      - .:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      vllm:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    environment:
      - POSTGRES_SERVER=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=talent_ai_interview
      - POSTGRES_USER=talent_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      - FIRST_SUPERUSER=admin@gmail.com
      - FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
      - ENVIRONMENT=local
      - PROJECT_NAME="OpenTalent - Interview (Engagement) Service"
      - STACK_NAME="interview-service"
      - BACKEND_CORS_ORIGINS="http://localhost,http://localhost:5173,https://localhost,https://localhost:5173,http://localhost.tiangolo.com"
      # vLLM and Qdrant configuration
      - VLLM_BASE_URL=http://vllm:8000
      - QDRANT_URL=http://qdrant:6333

volumes:
  postgres_data:
  qdrant_data:
  vllm_cache:
