version: '3.8'

services:
  voice-service:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: voice-service:latest
    container_name: voice-service
    restart: unless-stopped

    ports:
      - "8015:8015"

    environment:
      # Service configuration
      USE_MOCK_SERVICES: "false"
      ENABLE_WEBRTC: "true"

      # Model paths (relative to /app in container)
      VOSK_MODEL_PATH: "models/vosk-model-small-en-us-0.15"
      PIPER_MODEL_PATH: "models/en_US-lessac-medium.onnx"
      PIPER_CONFIG_PATH: "models/en_US-lessac-medium.onnx.json"
      PIPER_BINARY: "./piper/piper"
      SILERO_MODEL_PATH: "models/silero_vad.onnx"

      # Logging
      LOG_LEVEL: "info"
      PYTHONUNBUFFERED: "1"

    volumes:
      # Mount models directory (download models first with download_models.py)
      - ./models:/app/models:ro

      # Mount logs directory for persistent logging
      - ./logs:/app/logs

      # Mount temp directory for temporary audio files
      - ./temp:/app/temp

    networks:
      - open-talent-network

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8015/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    labels:
      - "com.OpenTalent.service=voice"
      - "com.OpenTalent.version=2.0.0"
      - "com.OpenTalent.description=Speech processing service with STT, TTS, and VAD"

networks:
  open-talent-network:
    name: open-talent-network
    driver: bridge
