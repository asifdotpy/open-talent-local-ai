# Avatar Service Endpoint Specification

> **Document:** Avatar Service API Specification  
> **Status:** ðŸ“‹ **IN EFFECT**  
> **Last Updated:** December 17, 2025  
> **Version:** 1.0.0

---

## Overview

This document specifies the **intended endpoint structure** for the Avatar Service (Port 8012). Use this as the source of truth for:
- What endpoints SHOULD exist
- What endpoints ARE duplicated
- What endpoints are missing
- Where each endpoint is defined

---

## Endpoint Categories

### 0. Current Implemented Endpoints (from OpenAPI)

The following endpoints are currently implemented and exposed by the service:

| Method | Path |
|--------|------|
| GET | `/` |
| GET | `/ping` |
| GET | `/health` |
| GET | `/api/v1/voices` |
| POST | `/api/v1/generate-voice` |
| POST | `/render/lipsync` |

Source: `curl -s http://127.0.0.1:8001/openapi.json | jq -r '.paths | keys[]'`

### 1. Core Service Status (No Duplication - âœ… GOOD)

| Method | Path | Location | Status | Purpose |
|--------|------|----------|--------|---------|
| **GET** | `/` | main.py line 176 | âœ… Primary | Service status & info |
| **GET** | `/ping` | main.py line 195 | âœ… Primary | Health check for load balancers |
| **GET** | `/health` | main.py line 234 | âœ… Primary | Comprehensive health status |

**Note:** These are defined in main.py directly (no router). This is OK because they're service-level, not API-specific.

---

### 2. Documentation & Discovery (No Duplication - âœ… GOOD)

| Method | Path | Location | Status | Purpose |
|--------|------|----------|--------|---------|
| **GET** | `/doc` | main.py line 201 | âœ… Primary | Redirect to /docs |
| **GET** | `/api-docs` | main.py line 207 | âœ… Primary | JSON list of all endpoints |
| **GET** | `/docs` | FastAPI auto | âœ… Auto | Swagger UI (FastAPI built-in) |
| **GET** | `/redoc` | FastAPI auto | âœ… Auto | ReDoc UI (FastAPI built-in) |
| **GET** | `/openapi.json` | FastAPI auto | âœ… Auto | OpenAPI schema |

**Note:** `/docs`, `/redoc`, `/openapi.json` are auto-generated by FastAPI. Others are custom.

---

### 3. Voice API (âŒ DUPLICATED - FIX NEEDED)

#### **DUPLICATE: `POST /api/v1/generate-voice`**

| Instance | Location | Status | Action |
|----------|----------|--------|--------|
| **1. Fallback** | main.py line 328 | âŒ REMOVE | Lines 323-330 (if condition block) |
| **2. Primary** | voice_routes.py line 28 | âœ… KEEP | Router-based definition |

**Intended Endpoints (FROM voice_routes.py router):**
```python
# Should come from included router, NOT duplicated in main.py
POST   /api/v1/generate-voice    - Generate voice from text
GET    /api/v1/voices             - List available voices
```

**Request Model:**
```python
class VoiceRequest(BaseModel):
    text: str
    voice_id: Optional[str] = "us-english-female-1"
```

**Response Model:**
```python
class VoiceResponse(BaseModel):
    audio: str  # base64-encoded audio
    voice_id: str
    text: str
    model_used: str
    metadata: dict
```

---

#### **DUPLICATE: `GET /api/v1/voices`**

| Instance | Location | Status | Action |
|----------|----------|--------|--------|
| **1. Fallback** | main.py line 332 | âŒ REMOVE | Lines 332-334 (get function) |
| **2. Primary** | voice_routes.py line 34 | âœ… KEEP | Router-based definition |

**Response Model:**
```python
class VoiceListResponse(BaseModel):
    voices: List[str]
    default_voice: str
    tts_engine: str
    supported_languages: List[str]
```

---

### 4. Avatar Rendering API (Multiple Routes - Check for Duplication)

These endpoints come from `avatar_routes.py` (included via `app.include_router(avatar_router)`):

| Method | Path | Location | Status | Purpose |
|--------|------|----------|--------|---------|
| **GET** | `/` | avatar_routes.py line 43 | âœ… Check | Serve avatar HTML page |
| **GET** | `/src/{path:path}` | avatar_routes.py line 56 | âœ… Check | Serve JS source files |
| **GET** | `/assets/{path:path}` | avatar_routes.py line 86 | âœ… Check | Serve avatar assets |
| **POST** | `/generate` | avatar_routes.py line 116 | âœ… Check | Generate avatar video |
| **POST** | `/set-phonemes` | avatar_routes.py line 180 | âœ… Check | Set phoneme data |
| **GET** | `/phonemes` | avatar_routes.py line 202 | âœ… Check | Get phoneme list |
| **POST** | `/generate-from-audio` | avatar_routes.py line 214 | âœ… Check | Generate from audio file |
| **GET** | `/info` | avatar_routes.py line 254 | âœ… Check | Service info |
| **GET** | `/health` | avatar_routes.py line 268 | âš ï¸ **DUPLICATE** | Health check |

**âš ï¸ ALERT:** `/health` endpoint appears **3 times**:
- main.py line 234 (primary)
- avatar_routes.py line 268 (duplicate from router)
- voice_routes.py line 19 (duplicate from router)

---

### 5. Avatar V1 API (Implemented)

These endpoints are implemented in `app/routes/avatar_v1.py` and mounted with the prefix `/api/v1/avatars`. They are present in the current OpenAPI output and provide comprehensive avatar controls.

| Method | Path | Prefix | Full Path | Purpose |
|--------|------|--------|-----------|---------|
| **POST** | `/render` | `/api/v1/avatars` | `/api/v1/avatars/render` | Render avatar |
| **POST** | `/lipsync` | `/api/v1/avatars` | `/api/v1/avatars/lipsync` | Lip-sync video |
| **POST** | `/emotions` | `/api/v1/avatars` | `/api/v1/avatars/emotions` | Set emotions |
| **GET** | `/presets` | `/api/v1/avatars` | `/api/v1/avatars/presets` | List presets |
| **GET** | `/presets/{preset_id}` | `/api/v1/avatars` | `/api/v1/avatars/presets/{preset_id}` | Get preset |
| **POST** | `/presets` | `/api/v1/avatars` | `/api/v1/avatars/presets` | Create preset |
| **PATCH** | `/presets/{preset_id}` | `/api/v1/avatars` | `/api/v1/avatars/presets/{preset_id}` | Update preset |
| **DELETE** | `/presets/{preset_id}` | `/api/v1/avatars` | `/api/v1/avatars/presets/{preset_id}` | Delete preset |
| **POST** | `/customize` | `/api/v1/avatars` | `/api/v1/avatars/customize` | Customize avatar |
| **GET** | `/{avatar_id}/state` | `/api/v1/avatars` | `/api/v1/avatars/{avatar_id}/state` | Get avatar state |
| **PATCH** | `/{avatar_id}/state` | `/api/v1/avatars` | `/api/v1/avatars/{avatar_id}/state` | Update avatar state |
| **POST** | `/phonemes` | `/api/v1/avatars` | `/api/v1/avatars/phonemes` | Extract phonemes |
| **POST** | `/phonemes/timing` | `/api/v1/avatars` | `/api/v1/avatars/phonemes/timing` | Get phoneme timing |
| **POST** | `/lipsync/preview` | `/api/v1/avatars` | `/api/v1/avatars/lipsync/preview` | Preview lip-sync |
| **GET** | `/visemes` | `/api/v1/avatars` | `/api/v1/avatars/visemes` | List visemes |
| **GET** | `/{avatar_id}/emotions` | `/api/v1/avatars` | `/api/v1/avatars/{avatar_id}/emotions` | Get emotions |
| **PATCH** | `/{avatar_id}/emotions` | `/api/v1/avatars` | `/api/v1/avatars/{avatar_id}/emotions` | Set emotions |
| **POST** | `/{avatar_id}/animations` | `/api/v1/avatars` | `/api/v1/avatars/{avatar_id}/animations` | Create animation |
| **GET** | `/config` | `/api/v1/avatars` | `/api/v1/avatars/config` | Get config |
| **PUT** | `/config` | `/api/v1/avatars` | `/api/v1/avatars/config` | Update config |
| **GET** | `/performance` | `/api/v1/avatars` | `/api/v1/avatars/performance` | Get performance metrics |

---

### 6. Main.py Endpoints (Service-level)

| Method | Path | Line | Status | Purpose |
|--------|------|------|--------|---------|
| **POST** | `/render/lipsync` | main.py line 265 | âœ… Implemented | Render with lip-sync |

**Note:** This is defined in main.py directly, NOT in a router. Check if it conflicts with router-based endpoints.

---

## Summary: Duplication Analysis

### âœ… CONFIRMED DUPLICATES (Resolved)

| Endpoint | Instances | Status | Fix |
|----------|-----------|--------|-----|
| **`POST /api/v1/generate-voice`** | 2 â†’ 1 | âœ… Resolved | Kept router; removed fallback in main.py |
| **`GET /api/v1/voices`** | 2 â†’ 1 | âœ… Resolved | Kept router; removed fallback in main.py |
| **`GET /health`** | 3 â†’ 1 | âœ… Resolved | Kept main.py; removed router duplicates |

### âš ï¸ POTENTIAL CONFLICTS (Resolved)

| Endpoint | Location | Conflict | Action |
|----------|----------|----------|--------|
| **`GET /`** | Removed from routers; main.py retained as service root |
| **`POST /render/lipsync`** | Implemented in main.py; no conflicting router endpoint present |

---

## Router Configuration

### How Routers Are Included

```python
# File: main.py (lines 140-153)

if USE_EXTERNAL_MODULES:
    app.include_router(avatar_router)          # avatar_routes.py
    
    try:
        from app.routes.avatar_v1 import router as avatar_v1_router
        app.include_router(avatar_v1_router)   # avatar_v1.py
    except ImportError:
        logger.warning("avatar_v1 router not available")

try:
    from app.routes.voice_routes import router as voice_router
    app.include_router(voice_router)           # voice_routes.py
except ImportError:
    logger.warning("voice_routes not available")
```

**Problem:** All routers are included WITHOUT prefixes, so they register endpoints at root level. This makes duplication obvious but also means endpoint paths must be carefully managed.

---

## Endpoint Count Verification

### Current State (from /api-docs output)

```
Total routes: 16

GET      /                  (duplicate)
GET      /                  (duplicate)
GET      /api-docs
GET      /api/v1/voices     (duplicate)
GET      /api/v1/voices     (duplicate)
GET      /doc
GET      /health            (duplicate)
GET      /health            (duplicate)
GET      /ping
HEAD     /docs/oauth2-redirect
POST     /api/v1/generate-voice    (duplicate)
POST     /api/v1/generate-voice    (duplicate)
POST     /render/lipsync
```

### Expected After Duplicates Removed

Should have ~13 unique routes instead of 16 total (with 7 duplicates).

---

## Remediation Plan

### Phase 1: Remove Voice Endpoint Duplicates (Priority: ðŸ”´ CRITICAL)

**Files to Edit:** `services/avatar-service/main.py`

**Changes:**
1. Delete lines 323-330 (entire `if VOICE_MODULES_AVAILABLE` block with fallback endpoints)
2. Keep lines 1-322 (everything else)
3. Verify voice_routes.py router is still included (lines 147-151)

**Result:** 
- `POST /api/v1/generate-voice` - defined only in voice_routes.py (1 instance)
- `GET /api/v1/voices` - defined only in voice_routes.py (1 instance)

**Testing:**
```bash
curl http://localhost:8012/api/v1/voices
# Should return: {"voices": [...]}
```

### Phase 2: Remove Health Endpoint Duplicates (Priority: ðŸŸ¡ HIGH)

**Files to Edit:** `services/avatar-service/app/routes/voice_routes.py`

**Changes:**
1. Remove the `@router.get("/health")` endpoint (lines 19-25)
2. Keep the voice route `/api/v1/generate-voice` and `/api/v1/voices`

**Result:**
- `GET /health` - defined only in main.py (1 instance)
- Other endpoints from routers don't conflict

**Why:** The main.py version is the primary service health endpoint. Router versions are redundant.

### Phase 3: Investigate Root Endpoint (Priority: ðŸŸ¢ MEDIUM)

**Files to Check:**
- main.py line 176: `@app.get("/")`
- voice_routes.py line 13: `@router.get("/")`

**Options:**
1. **If both serve the same purpose:** Remove one (keep main.py version)
2. **If they serve different purposes:** Document why both are needed
3. **Recommendation:** Keep main.py version (service root), remove router version

---

## Reference Implementation

### Example: Voice Route (Correct Pattern)

```python
# File: services/avatar-service/app/routes/voice_routes.py

from fastapi import APIRouter
from app.models.voice import VoiceRequest, VoiceResponse, VoiceListResponse
from app.services.voice_service import voice_service

router = APIRouter()

@router.post("/api/v1/generate-voice", response_model=VoiceResponse, tags=["Voice"])
async def generate_us_voice(request: VoiceRequest):
    """Generate US English female voice from text using local AI Voice."""
    return await voice_service.generate_us_voice(request)

@router.get("/api/v1/voices", response_model=VoiceListResponse, tags=["Voice"])
async def list_available_voices():
    """List available local AI voices (US English planned)."""
    return await voice_service.list_available_voices()

# DO NOT include same endpoints in main.py - router inclusion handles it
```

### Example: Main App Setup (Correct Pattern)

```python
# File: services/avatar-service/main.py

from fastapi import FastAPI

app = FastAPI()

# Include routers with endpoints
try:
    from app.routes.voice_routes import router as voice_router
    app.include_router(voice_router)  # Registers all @router endpoints from voice_routes.py
except ImportError:
    logger.warning("voice_routes not available")

# Define service-level endpoints in main (health, ping, etc.)
@app.get("/health")
async def health_check():
    """Service health check"""
    return {"status": "healthy"}

# DO NOT re-define router endpoints here - that creates duplication
```

---

## Testing Endpoints

### Verify No Duplication

```bash
# Get all endpoints as JSON
curl -s http://127.0.0.1:8012/api-docs | python -c "
import sys, json
data = json.load(sys.stdin)
paths = [r['path'] for r in data['routes']]
duplicates = [p for p in set(paths) if paths.count(p) > 1]
print(f'Total routes: {len(data[\"routes\"])}')
print(f'Unique paths: {len(set(paths))}')
if duplicates:
    print(f'Duplicates found: {duplicates}')
else:
    print('âœ… No duplicates')
"
```

### Expected Output After Fix

```
Total routes: 9
Unique paths: 9
âœ… No duplicates
```

---

## Documentation Standards

All endpoints should follow FastAPI conventions:

1. **Docstring:** Describe what the endpoint does
2. **Response Model:** Define exact response structure
3. **Tags:** Categorize endpoints (e.g., "Voice", "Avatar", "Status")
4. **Error Handling:** Document possible error responses

**Example:**
```python
@router.post(
    "/api/v1/generate-voice",
    response_model=VoiceResponse,
    tags=["Voice"],
    summary="Generate voice from text",
    responses={
        200: {"description": "Voice generated successfully"},
        400: {"description": "Invalid request"},
        500: {"description": "Service error"}
    }
)
async def generate_us_voice(request: VoiceRequest):
    """
    Generate US English female voice from text using local TTS.
    
    Args:
        request: VoiceRequest with text and optional voice_id
    
    Returns:
        VoiceResponse with audio data and metadata
    """
    return await voice_service.generate_us_voice(request)
```

---

## Maintenance Notes

### When to Update This Document

1. **Add endpoint:** Update section 3-5, run verification
2. **Remove endpoint:** Update section 3-5, update remediation plan
3. **Move endpoint:** Update location column, note in remediation plan
4. **Rename endpoint:** Update path column, note breaking change

### Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | Dec 17, 2025 | Initial specification based on code analysis |

---

## Links

- **Status:** [ENDPOINT_DUPLICATION_TRACKING.md](ENDPOINT_DUPLICATION_TRACKING.md) - Live tracking
- **Analysis:** [ENDPOINT_DUPLICATION_QUICK_REFERENCE.md](ENDPOINT_DUPLICATION_QUICK_REFERENCE.md) - Quick reference
- **Code:** [services/avatar-service/main.py](../services/avatar-service/main.py) - Main app file
- **Code:** [services/avatar-service/app/routes/](../services/avatar-service/app/routes/) - Route files
