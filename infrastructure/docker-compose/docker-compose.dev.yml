version: '3.8'

# Development Environment Overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  postgres:
    environment:
      - POSTGRES_PASSWORD=devpassword  # Simplified for local dev
    ports:
      - "5432:5432"  # Expose for DB clients
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g

  redis:
    command: >
      redis-server
      --requirepass devpassword
      --save ""
      --appendonly no
    ports:
      - "6379:6379"  # Expose for Redis clients
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 256m

  minio:
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"  # Console UI for dev

  ollama:
    environment:
      - OLLAMA_DEBUG=1
    volumes:
      - ollama-models:/root/.ollama
      - ../../models:/models:ro  # Mount local model directory

  avatar-service:
    build:
      context: ../../microservices/avatar-service
      target: development  # Use dev stage in Dockerfile
    environment:
      - DEBUG=true
      - HOT_RELOAD=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ../../microservices/avatar-service:/app:rw  # Hot reload
      - /app/node_modules  # Prevent overwriting node_modules
    command: npm run dev

  voice-service:
    build:
      context: ../../microservices/voice-service
      target: development
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ../../microservices/voice-service:/app:rw
    command: uvicorn main:app --host 0.0.0.0 --port 8002 --reload

  conversation-service:
    build:
      context: ../../microservices/conversation-service
      target: development
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ../../microservices/conversation-service:/app:rw
    command: uvicorn main:app --host 0.0.0.0 --port 8003 --reload

  interview-service:
    build:
      context: ../../microservices/interview-service
      target: development
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ../../microservices/interview-service:/app:rw
    command: uvicorn main:app --host 0.0.0.0 --port 8004 --reload

  scout-service:
    build:
      context: ../../microservices/scout-service
      target: development
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - MOCK_EXTERNAL_APIS=true  # Use mocks for GitHub/LinkedIn in dev
    volumes:
      - ../../microservices/scout-service:/app:rw
    command: uvicorn main:app --host 0.0.0.0 --port 8005 --reload

  analytics-service:
    build:
      context: ../../microservices/analytics-service
      target: development
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ../../microservices/analytics-service:/app:rw
    command: uvicorn main:app --host 0.0.0.0 --port 8007 --reload

  celery-render-worker:
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    command: >
      celery -A avatar_service.celery_app worker
      --loglevel=DEBUG
      --concurrency=2
      --queues=render
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g

  celery-beat:
    environment:
      - DEBUG=true
    command: celery -A avatar_service.celery_app beat --loglevel=DEBUG

  nginx:
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro  # Dev config with CORS
    ports:
      - "8080:80"

  # Development tools
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: talentai-pgadmin-dev
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@talentai.local
      - PGADMIN_DEFAULT_PASSWORD=devpassword
      - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
      - "5050:80"
    networks:
      - talentai-network

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: talentai-redis-commander-dev
    restart: unless-stopped
    environment:
      - REDIS_HOSTS=local:redis:6379:0:devpassword
    ports:
      - "8081:8081"
    networks:
      - talentai-network

networks:
  talentai-network:
    driver: bridge
