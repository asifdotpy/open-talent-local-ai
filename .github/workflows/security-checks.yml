name: Security & Quality Checks

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly security audit every Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install bandit safety semgrep ruff mypy pytest pytest-cov
      
      - name: Run Bandit security linter
        run: |
          bandit -r services/ -f json -o bandit-report.json || true
          bandit -r services/ -ll
        continue-on-error: true
      
      - name: Check dependencies for vulnerabilities
        run: |
          safety check --json || true
        continue-on-error: true
      
      - name: Run Semgrep security rules
        run: |
          semgrep --config=auto --json -o semgrep-report.json services/ || true
          semgrep --config=.semgrep/rules.yaml services/
        continue-on-error: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            semgrep-report.json
          retention-days: 30
  
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install ruff black mypy
      
      - name: Run Ruff linter
        run: |
          ruff check services/ --output-format=github
      
      - name: Check code formatting
        run: |
          black --check services/
      
      - name: Run type checker
        run: |
          mypy services/ --ignore-missing-imports
        continue-on-error: true
  
  tests:
    name: Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install pytest pytest-cov pytest-asyncio httpx
      
      - name: Run tests with coverage
        run: |
          pytest services/ --cov=services --cov-report=xml --cov-report=term-missing --cov-fail-under=70
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  
  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
      
      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        continue-on-error: true
  
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
  
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, tests, secrets-detection]
    if: always()
    
    steps:
      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
        continue-on-error: true
      
      - name: Generate summary
        run: |
          echo "## Security & Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets Detection: ${{ needs.secrets-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review security reports in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`./scripts/security-check.sh\` locally for detailed output" >> $GITHUB_STEP_SUMMARY
          echo "- See SECURITY_AND_CODE_QUALITY_CHECKLIST.md for remediation guidance" >> $GITHUB_STEP_SUMMARY
